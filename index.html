<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuwayï½œæ‹¼è²¼å¹¾ä½•æ–‡å‰µå®¢è£½é›¶å”®</title>
  <meta name="description" content="ç•¢å¡ç´¢é¢¨æ ¼çš„æ–‡å‰µå®¢è£½é›¶å”®ï¼šT-Shirtã€æ‰˜ç‰¹è¢‹ã€æµ·å ±ã€é¦¬å…‹æ¯ç­‰ï¼Œæ”¯æ´å³æ™‚å®¢è£½é è¦½ã€è³¼ç‰©è»Šèˆ‡çµå¸³ã€‚å…¬å¸ï¼šæ–°æ´¾ç§‘æŠ€æœ‰é™å…¬å¸ï¼Œçµ±ä¸€ç·¨è™Ÿï¼š60485361ã€‚" />
  <meta name="theme-color" content="#0ea5a6" />
  <style>
    :root{
      --ink:#1f2937;      /* gray-800 */
      --muted:#6b7280;    /* gray-500 */
      --bg:#f8fafc;       /* slate-50 */
      --card:#ffffff;     /* white */
      --brand:#0ea5a6;    /* teal-500 */
      --brand-dark:#0b8c8d;/* teal-600 */
      --accent:#f59e0b;   /* amber-500 */
      --danger:#ef4444;   /* red-500 */
      --success:#10b981;  /* emerald-500 */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang TC","Microsoft JhengHei",sans-serif;}
    a{color:var(--brand);text-decoration:none}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.8);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1120px;margin:auto;padding:0 16px}
    .row{display:flex;gap:16px;align-items:center;}
    .space{flex:1}
    .brand{display:flex;align-items:center;gap:12px;padding:14px 0}
    .brand svg{width:36px;height:36px}
    .brand h1{font-size:18px;margin:0}
    nav a{padding:8px 10px;border-radius:10px}
    nav a:hover{background:#eef2f7}
    .cta{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:var(--card);cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.primary:hover{background:var(--brand-dark)}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.success{background:var(--success);border-color:var(--success);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .hero{position:relative;overflow:hidden;border-bottom:1px solid #e5e7eb}
    .hero .inner{padding:40px 0}
    .hero h2{font-size:28px;margin:0 0 8px}
    .hero p{color:var(--muted);margin:0 0 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 1px 1px rgba(0,0,0,.02)}
    .card.pad{padding:16px}
    .product-card{display:flex;flex-direction:column}
    .product-thumb{height:160px;border-bottom:1px dashed #e5e7eb;display:grid;place-items:center;background:linear-gradient(135deg,#fff 0%,#f3f4f6 100%);border-radius:18px 18px 0 0;position:relative;overflow:hidden}
    .product-body{padding:14px}
    .product-title{font-weight:700;margin:0 0 6px}
    .product-meta{color:var(--muted);font-size:14px;margin-bottom:10px}
    .price{font-weight:800}

    .sidecart{position:fixed;right:16px;bottom:16px;z-index:60}
    .cart-fab{position:relative}
    .badge{position:absolute;right:-6px;top:-6px;background:var(--accent);color:#111827;border-radius:999px;font-weight:800;font-size:12px;min-width:22px;height:22px;display:grid;place-items:center;border:1px solid #f59e0b}

    .drawer{position:fixed;right:0;top:0;height:100%;width:min(420px,92vw);background:#fff;border-left:1px solid #e5e7eb;box-shadow:-10px 0 40px rgba(0,0,0,.06);transform:translateX(100%);transition:transform .32s ease;z-index:70;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer header{position:sticky;top:0;border-bottom:1px solid #e5e7eb;background:#fff}
    .drawer .body{padding:14px;overflow:auto;flex:1}
    .drawer .foot{padding:14px;border-top:1px solid #e5e7eb}
    .line{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #e5e7eb}
    .muted{color:var(--muted)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;z-index:80;overflow:auto}
    .modal.open{display:grid;place-items:center}
    /* make columns shrinkable to avoid overflow */
    .panel{background:#fff;width:min(1040px,96vw);max-height:92vh;border-radius:18px;border:1px solid #e5e7eb;display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,0.8fr)}
    .panel .preview{padding:16px;border-right:1px solid #e5e7eb;min-width:0}
    .panel .preview canvas{max-width:100%;height:auto;display:block}
    .panel .form{padding:16px;overflow:auto;min-width:0}

    .field{display:flex;flex-direction:column;margin-bottom:10px}
    .field label{font-weight:700;margin-bottom:6px}
    .field input,.field select,.field textarea{padding:10px;border:1px solid #e5e7eb;border-radius:12px;font:inherit}
    .group{border:1px solid #e5e7eb;border-radius:14px;margin-bottom:12px;background:#fff}
    .group summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:800;display:flex;align-items:center;gap:8px}
    /* hide native marker to prevent double bullets */
    .group summary::-webkit-details-marker{display:none}
    /* correct arrow rotation states */
    .group summary::before{content:'â–¸';display:inline-block;transform:rotate(0deg);transition:transform .2s ease}
    .group[open] summary::before{transform:rotate(90deg)}
    .group .inner{padding:12px 14px;border-top:1px solid #e5e7eb}

    .optgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .optgrid .col-6{grid-column:span 12}
    .optgrid .col-4{grid-column:span 12}
    .optgrid .col-8{grid-column:span 12}
    @media (min-width: 860px){
      .optgrid .col-6{grid-column:span 6}
      .optgrid .col-4{grid-column:span 4}
      .optgrid .col-8{grid-column:span 8}
    }

    .checkout{margin:30px 0}
    .kvs{display:grid;grid-template-columns:1fr auto;gap:8px}
    .kvs .k{color:var(--muted)}
    .divider{height:1px;background:#e5e7eb;margin:10px 0}

    footer{margin-top:40px;border-top:1px solid #e5e7eb}
    footer .inner{padding:20px 0;color:#6b7280;font-size:14px}

    /* Picasso-esque shapes for the hero using pure CSS/SVG */
    .hero-canvas{position:absolute;inset:0;pointer-events:none}
    .shape{position:absolute;opacity:.9;filter:drop-shadow(0 4px 16px rgba(0,0,0,.08))}
    .s1{left:-40px;top:-40px;width:180px;height:180px;background:#fde68a;transform:rotate(18deg) skew(6deg)}
    .s2{right:10%;top:10%;width:140px;height:140px;background:#a7f3d0;border-radius:60% 40% 70% 30%/50% 50% 60% 40%;transform:rotate(-12deg)}
    .s3{left:35%;bottom:-40px;width:220px;height:220px;background:#93c5fd;clip-path:polygon(0 55%,45% 0,100% 35%,85% 100%,20% 90%)}
    .s4{right:-60px;bottom:-60px;width:220px;height:220px;background:#fca5a5;border-radius:12% 68% 20% 60% / 40% 30% 70% 60%}

    @media (max-width: 860px){
      .modal .panel{grid-template-columns:1fr}
      .panel .preview{border-right:none;border-bottom:1px solid #e5e7eb}
      .hero .inner{padding:26px 0}
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand" aria-label="å“ç‰Œ">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="#0ea5a6"/>
              <stop offset="100%" stop-color="#f59e0b"/>
            </linearGradient>
          </defs>
          <path d="M12 50 Q 50 6 88 50 T 12 50" fill="url(#g)"/>
          <circle cx="50" cy="50" r="10" fill="#111827" />
        </svg>
        <h1>æ–°æ´¾ç§‘æŠ€ï½œNuway Lab æ–‡å‰µå®¢è£½</h1>
      </div>
      <nav class="row" aria-label="å°è¦½">
        <a href="#products">å•†å“</a>
        <a href="#how">å¦‚ä½•å®¢è£½</a>
        <a href="#checkout">çµå¸³</a>
      </nav>
      <div class="space"></div>
      <div class="cta">
        <button class="btn ghost" id="openCart" aria-label="é–‹å•Ÿè³¼ç‰©è»Š">ğŸ§º è³¼ç‰©è»Š</button>
        <button class="btn primary" onclick="scrollToCheckout()">å‰å¾€çµå¸³</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="hero-canvas" aria-hidden="true">
      <div class="shape s1"></div>
      <div class="shape s2"></div>
      <div class="shape s3"></div>
      <div class="shape s4"></div>
    </div>
    <div class="wrap inner grid" style="grid-template-columns:repeat(12,1fr);align-items:center;gap:24px">
      <div class="card pad" style="grid-column:span 7">
        <h2>æ‹¼è²¼å¹¾ä½•é¢¨æ ¼ Ã— å®¢è£½åŒ–æ–‡å‰µ</h2>
        <p>é€éå¹¾ä½•åˆ‡å‰²ã€æ‹¼è²¼æ§‹æˆèˆ‡å¼·çƒˆé…è‰²ï¼Œæ‰“é€ ä½ çš„å°ˆå±¬é¢¨æ ¼ã€‚æ”¯æ´å³æ™‚é è¦½ã€å®¢è£½åƒæ•¸èˆ‡è³¼ç‰©è»Šçµå¸³ã€‚</p>
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <button class="btn primary" onclick="document.getElementById('products').scrollIntoView({behavior:'smooth'})">é–‹å§‹é¸è³¼</button>
          <button class="btn" onclick="newDesign()">éš¨æ©Ÿé…è‰²éˆæ„Ÿ</button>
        </div>
      </div>
      <div class="card" style="grid-column:span 5;overflow:hidden">
        <canvas id="heroPreview" width="600" height="360" aria-label="è¨­è¨ˆé è¦½ç•«å¸ƒ"></canvas>
      </div>
    </div>
  </section>

  <main class="wrap">
    <section id="products" style="margin:26px 0">
      <h3 style="margin:0 0 12px">ç²¾é¸å•†å“</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr)">
        <!-- Product cards will be injected here -->
      </div>
    </section>

    <section id="how" class="grid" style="grid-template-columns:repeat(12,1fr);gap:16px">
      <div class="card pad" style="grid-column:span 12">
        <h3>å¦‚ä½•å®¢è£½</h3>
        <ol style="margin:0;padding-left:18px">
          <li>é¸æ“‡å•†å“ï¼ˆT-Shirtã€æ‰˜ç‰¹è¢‹ã€æµ·å ±ã€é¦¬å…‹æ¯â€¦ï¼‰ã€‚</li>
          <li>è¨­å®šé…è‰²ã€å¹¾ä½•åœ–å½¢ã€ç­†è§¸ã€å­—æ¨£èˆ‡å°ºå¯¸ã€‚</li>
          <li>å³æ™‚é è¦½è¨­è¨ˆï¼ŒåŠ å…¥è³¼ç‰©è»Šã€‚</li>
          <li>åœ¨çµå¸³é å¡«å¯«è¯çµ¡èˆ‡å¯„é€è³‡è¨Šï¼Œé€å‡ºè¨‚å–®ã€‚</li>
        </ol>
        <p class="muted">æœ¬é é¢ä¹‹åœ–æ¡ˆç”±æ¼”ç®—æ³•å³æ™‚ç”¢ç”Ÿï¼Œåƒ…å…·å¹¾ä½•/æ‹¼è²¼éˆæ„Ÿï¼Œä¸ç›´æ¥ä½¿ç”¨æˆ–è¤‡è£½ä»»ä½•å—è‘—ä½œæ¬Šä¿è­·ä¹‹ä½œå“ã€‚</p>
      </div>
    </section>

    <section id="checkout" class="checkout">
      <h3>çµå¸³</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:16px">
        <div class="card pad" style="grid-column:span 7">
          <h4 style="margin-top:0">è¯çµ¡èˆ‡å¯„é€</h4>
          <form id="checkoutForm">
            <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:12px">
              <div class="field" style="grid-column:span 6">
                <label for="name">å§“å</label>
                <input id="name" required placeholder="" />
              </div>
              <div class="field" style="grid-column:span 6">
                <label for="email">Email</label>
                <input id="email" type="email" required placeholder="" />
              </div>
              <div class="field" style="grid-column:span 6">
                <label for="phone">é›»è©±</label>
                <input id="phone" required placeholder="" />
              </div>
              <div class="field" style="grid-column:span 6">
                <label for="zipcode">éƒµéå€è™Ÿ</label>
                <input id="zipcode" required placeholder="" />
              </div>
              <div class="field" style="grid-column:span 12">
                <label for="address">å¯„é€åœ°å€</label>
                <input id="address" required placeholder="" />
              </div>
              <div class="field" style="grid-column:span 12">
                <label for="note">å‚™è¨»</label>
                <textarea id="note" rows="3" placeholder=""></textarea>
              </div>
            </div>
            <div class="divider"></div>
            <div class="row" style="justify-content:flex-end;gap:10px">
              <button class="btn" type="button" onclick="downloadOrderJSON()">ä¸‹è¼‰è¨‚å–®</button>
              <button class="btn primary" type="submit">é€å‡ºè¨‚å–®</button>
            </div>
          </form>
        </div>
        <div class="card pad" style="grid-column:span 5">
          <h4 style="margin-top:0">è¨‚å–®æ‘˜è¦</h4>
          <div id="orderSummary"></div>
          <div class="divider"></div>
          <div class="kvs">
            <div class="k">å°è¨ˆ</div><div id="sumSub">NT$0</div>
            <div class="k">é‹è²»</div><div id="sumShip">NT$80</div>
            <div class="k">åˆè¨ˆ</div><div id="sumTotal" style="font-weight:800">NT$0</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap inner">
      <div>Â© <span id="year"></span> æ–°æ´¾ç§‘æŠ€æœ‰é™å…¬å¸ï½œçµ±ä¸€ç·¨è™Ÿï¼š60485361</div>
    </div>
  </footer>

  <!-- Floating Cart FAB -->
  <div class="sidecart">
    <button class="btn primary cart-fab" id="fabCart">ğŸ§º è³¼ç‰©è»Š <span class="badge" id="cartCount">0</span></button>
  </div>

  <!-- Cart Drawer -->
  <aside class="drawer" id="cartDrawer" aria-label="è³¼ç‰©è»ŠæŠ½å±œ">
    <header class="row wrap" style="padding:12px 16px">
      <strong>ä½ çš„è³¼ç‰©è»Š</strong>
      <div class="space"></div>
      <button class="btn" onclick="toggleCart(false)">é—œé–‰</button>
    </header>
    <div class="body" id="cartItems"></div>
    <div class="foot">
      <div class="kvs">
        <div class="k">å°è¨ˆ</div><div id="cartSub">NT$0</div>
        <div class="k">é‹è²»ï¼ˆå›ºå®šï¼‰</div><div>NT$80</div>
        <div class="k">åˆè¨ˆ</div><div id="cartTotal" style="font-weight:800">NT$0</div>
      </div>
      <div class="row" style="margin-top:10px;gap:10px">
        <button class="btn" onclick="clearCart()">æ¸…ç©º</button>
        <button class="btn success" onclick="scrollToCheckout();toggleCart(false)">å‰å¾€çµå¸³</button>
      </div>
    </div>
  </aside>

  <!-- Customization Modal (streamlined) -->
  <div class="modal" id="customModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="panel">
      <div class="preview">
        <canvas id="designPreview" width="720" height="480" aria-label="å®¢è£½é è¦½ç•«å¸ƒ"></canvas>
      </div>
      <div class="form">
        <div class="row" style="align-items:center">
          <h4 id="modalTitle" style="margin:0">å®¢è£½è¨­å®š</h4>
          <div class="space"></div>
          <button class="btn" onclick="closeModal()">é—œé–‰</button>
        </div>
        <div class="divider"></div>

        <details class="group" open>
          <summary>â‘  å•†å“èˆ‡è¦æ ¼</summary>
          <div class="inner optgrid">
            <div class="field col-6">
              <label>å•†å“</label>
              <select id="optProduct"></select>
            </div>
            <div class="field col-6">
              <label>å°ºå¯¸/è¦æ ¼</label>
              <select id="optSize"></select>
            </div>
          </div>
        </details>

        <details class="group" open>
          <summary>â‘¡ é…è‰²èˆ‡åœ–å½¢</summary>
          <div class="inner optgrid">
            <div class="field col-6">
              <label>ä¸»è‰²ç³»</label>
              <select id="optPalette">
                <option value="teal">å†·ç¶ è—</option>
                <option value="warm">æš–æ—¥å…‰</option>
                <option value="mono">é»‘ç™½ç°</option>
                <option value="fiesta">å˜‰å¹´è¯</option>
                <option value="rose">ç«ç‘°èª¿</option>
              </select>
            </div>
            <div class="field col-6">
              <label>é»ç¶´</label>
              <select id="optAccent">
                <option value="gold">é‡‘é»ƒ</option>
                <option value="sky">å¤©è—</option>
                <option value="scarlet">é®®ç´…</option>
                <option value="lime">è¢å…‰ç¶ </option>
              </select>
            </div>
            <div class="field col-6">
              <label>å¹¾ä½•çµ„æ…‹</label>
              <select id="optGeometry">
                <option value="cubes">ç«‹é«”åˆ‡å‰²</option>
                <option value="facets">ç¢ç‰‡æ‹¼è²¼</option>
                <option value="lines">ç·šæ¢äº¤éŒ¯</option>
                <option value="faces">æŠ½è±¡é¢å­”</option>
              </select>
            </div>
            <div class="field col-6">
              <label>ç­†è§¸</label>
              <select id="optBrush">
                <option value="flat">å¹³å¡—</option>
                <option value="noise">ç²—å™ªé»</option>
                <option value="hatch">æ’ç·š</option>
              </select>
            </div>
          </div>
        </details>

        <details class="group" open>
          <summary>â‘¢ å­—æ¨£èˆ‡æ•¸é‡</summary>
          <div class="inner optgrid">
            <div class="field col-8">
              <label>è‡ªè¨‚å­—æ¨£</label>
              <input id="optText" maxlength="20" placeholder="EX: CUBIST LIFE" />
            </div>
            <div class="field col-4">
              <label>å­—æ¨£ä½ç½®</label>
              <select id="optTextPos">
                <option value="top">ä¸Šæ–¹</option>
                <option value="center">ä¸­å¤®</option>
                <option value="bottom">ä¸‹æ–¹</option>
              </select>
            </div>
            <div class="field col-6">
              <label>æ•¸é‡</label>
              <input id="optQty" type="number" min="1" value="1" />
            </div>
          </div>
        </details>

        <div class="row" style="justify-content:flex-end;gap:10px;margin-top:8px">
          <button class="btn" onclick="randomizeDesign()">éš¨æ©Ÿéˆæ„Ÿ</button>
          <button class="btn primary" onclick="addToCartFromModal()">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ---------- Data ----------
  const PRODUCTS = [
    {id:'tee', name:'å®¢è£½ T-Shirt', basePrice:690, sizes:['S','M','L','XL'], mock:'è¡£'},
    {id:'tote', name:'å¸†å¸ƒæ‰˜ç‰¹è¢‹', basePrice:520, sizes:['Small','Medium','Large'], mock:'è¢‹'},
    {id:'poster', name:'ç¾è¡“æµ·å ±', basePrice:480, sizes:['A4','A3','A2'], mock:'ç´™'},
    {id:'mug', name:'é¦¬å…‹æ¯', basePrice:380, sizes:['300ml','450ml'], mock:'æ¯'},
    {id:'phone', name:'æ‰‹æ©Ÿæ®¼', basePrice:590, sizes:['iPhone','Android é€šç”¨'], mock:'æ®¼'},
    {id:'notebook', name:'ç­†è¨˜æœ¬', basePrice:350, sizes:['A6','A5'], mock:'æœ¬'},
  ];

  const PRESETS = {
    palette:{
      teal:['#0ea5a6','#f59e0b','#e5e7eb','#1f2937','#84cc16'],
      warm:['#fb923c','#f59e0b','#fca5a5','#fde68a','#1f2937'],
      mono:['#111827','#4b5563','#9ca3af','#e5e7eb','#ffffff'],
      fiesta:['#ef4444','#22c55e','#3b82f6','#f59e0b','#a855f7'],
      rose:['#f43f5e','#fb7185','#fecdd3','#94a3b8','#111827']
    },
    accent:{gold:'#f59e0b',sky:'#38bdf8',scarlet:'#ef4444',lime:'#84cc16'}
  };

  let state = {
    cart: JSON.parse(localStorage.getItem('cart')||'[]'),
    modal:{open:false, product:PRODUCTS[0].id, size:PRODUCTS[0].sizes[0], palette:'teal', geometry:'cubes', brush:'flat', accent:'gold', text:'', textPos:'top', qty:1}
  };

  // ---------- Utilities ----------
  const $ = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const money = n=>`NT$${n.toLocaleString('zh-Hant-TW')}`;

  function saveCart(){ localStorage.setItem('cart', JSON.stringify(state.cart)); renderCart(); renderOrderSummary(); updateCartBadge(); }
  function updateCartBadge(){ $('#cartCount').textContent = state.cart.reduce((a,b)=>a+b.qty,0); }

  function toggleCart(open){ $('#cartDrawer').classList.toggle('open', open ?? !$('#cartDrawer').classList.contains('open')); }
  $('#fabCart').addEventListener('click',()=>toggleCart(true));
  $('#openCart').addEventListener('click',()=>toggleCart(true));

  function scrollToCheckout(){ document.getElementById('checkout').scrollIntoView({behavior:'smooth'}); }

  // ---------- Products ----------
  function renderProducts(){
    const grid = document.querySelector('#products .grid');
    grid.innerHTML = '';
    PRODUCTS.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'card product-card';
      card.style.gridColumn = 'span 4';
      card.innerHTML = `
        <div class="product-thumb">
          <canvas width="240" height="140" data-thumb="${p.id}"></canvas>
        </div>
        <div class="product-body">
          <h4 class="product-title">${p.name}</h4>
          <div class="product-meta">åŸºç¤åƒ¹æ ¼ <span class="price">${money(p.basePrice)}</span></div>
          <div class="row" style="gap:8px">
            <button class="btn" data-customize="${p.id}">å®¢è£½</button>
            <button class="btn primary" data-quickadd="${p.id}">å¿«é€ŸåŠ å…¥</button>
          </div>
        </div>`;
      grid.appendChild(card);
    });

    // draw thumbs
    PRODUCTS.forEach(p=>drawCubist($(`canvas[data-thumb="${p.id}"]`), {palette:'fiesta', geometry:'facets', brush:'hatch', accent:'sky', text:p.mock, textPos:'center'}));

    // bind buttons
    $$('button[data-customize]').forEach(btn=>btn.addEventListener('click',()=>openModal(btn.dataset.customize)));
    $$('button[data-quickadd]').forEach(btn=>btn.addEventListener('click',()=>quickAdd(btn.dataset.quickadd)));
  }

  function quickAdd(pid){
    const p = PRODUCTS.find(x=>x.id===pid);
    const entry = {id:crypto.randomUUID(), pid:p.id, name:p.name, size:p.sizes[0], palette:'fiesta', geometry:'facets', brush:'flat', accent:'sky', text:'', textPos:'bottom', qty:1, price:p.basePrice};
    state.cart.push(entry); saveCart(); toggleCart(true);
  }

  // ---------- Modal + Preview ----------
  function openModal(pid){
    const p = PRODUCTS.find(x=>x.id===pid);
    state.modal = {open:true, product:p.id, size:p.sizes[0], palette:'teal', geometry:'cubes', brush:'flat', accent:'gold', text:'', textPos:'top', qty:1};
    // fill selects
    const optP = $('#optProduct'); optP.innerHTML = PRODUCTS.map(x=>`<option value="${x.id}">${x.name}</option>`).join(''); optP.value = p.id;
    const optS = $('#optSize'); optS.innerHTML = p.sizes.map(s=>`<option>${s}</option>`).join('');
    $('#optPalette').value='teal'; $('#optGeometry').value='cubes'; $('#optBrush').value='flat'; $('#optAccent').value='gold';
    $('#optText').value=''; $('#optTextPos').value='top'; $('#optQty').value=1;

    $('#customModal').classList.add('open');
    renderDesignPreview();
  }
  function closeModal(){ $('#customModal').classList.remove('open'); }

  ['optProduct','optSize','optPalette','optGeometry','optBrush','optAccent','optText','optTextPos','optQty'].forEach(id=>{
    document.addEventListener('input', e=>{ if(e.target.id===id){ onOptionChange(); }});
    document.addEventListener('change', e=>{ if(e.target.id===id){ onOptionChange(); }});
  });
  function onOptionChange(){
    const pid = $('#optProduct').value; const p = PRODUCTS.find(x=>x.id===pid);
    if(p && $('#optSize').options.length!==p.sizes.length){ $('#optSize').innerHTML = p.sizes.map(s=>`<option>${s}</option>`).join(''); }
    state.modal.product = pid; state.modal.size = $('#optSize').value; state.modal.palette=$('#optPalette').value;
    state.modal.geometry=$('#optGeometry').value; state.modal.brush=$('#optBrush').value; state.modal.accent=$('#optAccent').value;
    state.modal.text=$('#optText').value.toUpperCase(); state.modal.textPos=$('#optTextPos').value; state.modal.qty=parseInt($('#optQty').value||1);
    renderDesignPreview();
  }

  function randomizeDesign(){
    const pal = Object.keys(PRESETS.palette)[Math.floor(Math.random()*5)];
    const geom = ['cubes','facets','lines','faces'][Math.floor(Math.random()*4)];
    const brush = ['flat','noise','hatch'][Math.floor(Math.random()*3)];
    const acc = ['gold','sky','scarlet','lime'][Math.floor(Math.random()*4)];
    $('#optPalette').value=pal; $('#optGeometry').value=geom; $('#optBrush').value=brush; $('#optAccent').value=acc;
    onOptionChange();
  }

  function addToCartFromModal(){
    const p = PRODUCTS.find(x=>x.id===state.modal.product);
    const price = p.basePrice + (state.modal.size?.length||0) * 5; // tiny size-based bump
    const entry = {id:crypto.randomUUID(), pid:p.id, name:p.name, size:state.modal.size, palette:state.modal.palette, geometry:state.modal.geometry, brush:state.modal.brush, accent:state.modal.accent, text:state.modal.text, textPos:state.modal.textPos, qty:state.modal.qty, price};
    state.cart.push(entry); saveCart(); closeModal(); toggleCart(true);
  }

  function renderDesignPreview(){
    const c = $('#designPreview'); drawCubist(c, state.modal);
  }

  // ---------- Drawing Cubist Composition ----------
  function drawCubist(canvas, opts){
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    const palette = PRESETS.palette[opts.palette] || PRESETS.palette.teal;
    const accent = PRESETS.accent[opts.accent] || '#f59e0b';

    // background blocks
    for(let i=0;i<9;i++){
      ctx.fillStyle = palette[i % palette.length];
      const w = rand(W*.2, W*.6), h = rand(H*.15, H*.5);
      const x = rand(-W*.1, W*.9), y = rand(-H*.1, H*.9);
      ctx.save();
      ctx.translate(x,y); ctx.rotate(rand(-.35,.35));
      roundRect(ctx, 0,0,w,h, rand(6,18)); ctx.fill();
      if(opts.brush==='noise') addNoise(ctx, x,y,w,h, 14, .08);
      if(opts.brush==='hatch') addHatch(ctx, x,y,w,h, 8);
      ctx.restore();
    }

    // geometry overlays
    ctx.globalAlpha = .85;
    if(opts.geometry==='cubes' || opts.geometry==='facets'){
      const n = opts.geometry==='cubes'?6:10;
      for(let i=0;i<n;i++){
        ctx.fillStyle = palette[(i+2)%palette.length];
        ctx.beginPath();
        ctx.moveTo(rand(0,W), rand(0,H));
        for(let k=0;k<4;k++) ctx.lineTo(rand(0,W), rand(0,H));
        ctx.closePath(); ctx.fill();
      }
    }
    if(opts.geometry==='lines'){
      for(let i=0;i<12;i++){
        ctx.strokeStyle = palette[i%palette.length]; ctx.lineWidth = rand(2,8);
        ctx.beginPath(); ctx.moveTo(rand(0,W), rand(0,H)); ctx.lineTo(rand(0,W), rand(0,H)); ctx.stroke();
      }
    }
    if(opts.geometry==='faces'){
      // abstract face: eye + nose + mouth as simple shapes
      ctx.fillStyle = palette[0]; circle(ctx, W*0.35,H*0.35, rand(20,36));
      ctx.fillStyle = palette[1]; circle(ctx, W*0.65,H*0.35, rand(12,28));
      ctx.fillStyle = palette[2]; triangle(ctx, W*0.5,H*0.25, W*0.46,H*0.55, W*0.54,H*0.55);
      ctx.fillStyle = palette[3]; roundRect(ctx, W*0.38,H*0.65, W*0.24,14, 7); ctx.fill();
    }

    // accent stroke
    ctx.globalAlpha = 1; ctx.strokeStyle = accent; ctx.lineWidth = 4; ctx.strokeRect(6,6,W-12,H-12);

    // text
    if(opts.text){
      ctx.fillStyle = '#111827'; ctx.font = '700 36px \'Noto Sans TC\',sans-serif'; ctx.textAlign='center';
      let y = opts.textPos==='top'? 48 : opts.textPos==='center'? H/2 : H-24;
      ctx.fillText(opts.text, W/2, y);
    }
  }

  function rand(min,max){ return Math.random()*(max-min)+min }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function addNoise(ctx,x,y,w,h,density=10,alpha=.1){ const img = ctx.getImageData(x,y,w,h); for(let i=0;i< w*h/density; i++){ const px = Math.floor(Math.random()*w), py=Math.floor(Math.random()*h); const idx=((py*w)+px)*4; img.data[idx]=img.data[idx+1]=img.data[idx+2]=0; img.data[idx+3]=255*alpha; } ctx.putImageData(img,x,y); }
  function addHatch(ctx,x,y,w,h,step=8){ ctx.save(); ctx.strokeStyle='rgba(17,24,39,.2)'; ctx.lineWidth=1; ctx.beginPath(); for(let i=-h;i<w;i+=step){ ctx.moveTo(x+i,y); ctx.lineTo(x+i+h,y+h); } ctx.stroke(); ctx.restore(); }
  function circle(ctx,x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); ctx.fill(); }
  function triangle(ctx,ax,ay,bx,by,cx,cy){ ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.lineTo(cx,cy); ctx.closePath(); ctx.fill(); }

  // ---------- Cart ----------
  function renderCart(){
    const box = $('#cartItems'); box.innerHTML='';
    if(state.cart.length===0){ box.innerHTML = '<p class="muted">è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„ã€‚</p>'; updateCartBadge(); $('#cartSub').textContent=money(0); $('#cartTotal').textContent=money(80); return; }

    state.cart.forEach(item=>{
      const row = document.createElement('div'); row.className='line';
      row.innerHTML = `
        <div style="max-width:72%">
          <div style="font-weight:700">${item.name}ï½œ${item.size}</div>
          <div class="muted" style="font-size:12px">${item.geometry} / ${item.palette} / ${item.brush} / ${item.accent}${item.text?`ï½œ\u3010${item.text}\u3011`:''}</div>
          <div class="muted" style="font-size:12px">å–®åƒ¹ ${money(item.price)} Ã— <input type="number" min="1" value="${item.qty}" data-qty="${item.id}" style="width:64px"> = <strong>${money(item.price*item.qty)}</strong></div>
        </div>
        <div>
          <button class="btn danger" data-remove="${item.id}">åˆªé™¤</button>
        </div>`;
      box.appendChild(row);
    });

    box.querySelectorAll('input[data-qty]').forEach(inp=>inp.addEventListener('input',(e)=>{
      const it = state.cart.find(x=>x.id===e.target.dataset.qty); it.qty = Math.max(1, parseInt(e.target.value||1)); saveCart();
    }));
    box.querySelectorAll('button[data-remove]').forEach(btn=>btn.addEventListener('click',()=>removeItem(btn.dataset.remove)));

    const sub = state.cart.reduce((a,b)=>a + b.price*b.qty, 0);
    $('#cartSub').textContent = money(sub);
    $('#cartTotal').textContent = money(sub+80);
  }
  function removeItem(id){ state.cart = state.cart.filter(x=>x.id!==id); saveCart(); }
  function clearCart(){ state.cart = []; saveCart(); }

  // ---------- Order Summary ----------
  function renderOrderSummary(){
    const box = $('#orderSummary');
    if(state.cart.length===0){ box.innerHTML='<p class="muted">è³¼ç‰©è»Šç‚ºç©ºï¼Œè«‹å…ˆåŠ å…¥å•†å“ã€‚</p>'; $('#sumSub').textContent=money(0); $('#sumTotal').textContent=money(80); return; }
    box.innerHTML = state.cart.map(it=>`<div class="line"><div>${it.name}ï½œ${it.size}<br><span class="muted" style="font-size:12px">${it.geometry}/${it.palette}/${it.brush}/${it.accent}${it.text?`ï½œ\u3010${it.text}\u3011`:''}</span></div><div>${money(it.price)} Ã— ${it.qty}</div></div>`).join('');
    const sub = state.cart.reduce((a,b)=>a + b.price*b.qty, 0);
    $('#sumSub').textContent = money(sub);
    $('#sumTotal').textContent = money(sub+80);
  }

  // ---------- Checkout ----------
  $('#checkoutForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    if(state.cart.length===0){ alert('è³¼ç‰©è»Šç‚ºç©º'); return; }
    const order = collectOrder();
    alert('å·²æ”¶åˆ°è¨‚å–®ã€‚');
    console.log('ORDER', order);
    // For demo, clear cart after "submit"
    clearCart(); renderCart(); renderOrderSummary();
  });

  function collectOrder(){
    const sub = state.cart.reduce((a,b)=>a + b.price*b.qty, 0);
    return {
      company:{name:'æ–°æ´¾ç§‘æŠ€æœ‰é™å…¬å¸', taxId:'60485361'},
      timestamp: new Date().toISOString(),
      items: state.cart,
      summary:{subtotal:sub, shipping:80, total:sub+80},
      contact:{
        name: $('#name').value, email: $('#email').value, phone: $('#phone').value,
        zipcode: $('#zipcode').value, address: $('#address').value, note: $('#note').value
      }
    };
  }

  function downloadOrderJSON(){
    const order = collectOrder();
    const blob = new Blob([JSON.stringify(order, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `order_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
  }

  // ---------- Hero Random Preview ----------
  function newDesign(){ drawCubist($('#heroPreview'), {palette: ['teal','warm','mono','fiesta','rose'][Math.floor(Math.random()*5)], geometry:['cubes','facets','lines','faces'][Math.floor(Math.random()*4)], brush:['flat','noise','hatch'][Math.floor(Math.random()*3)], accent:['gold','sky','scarlet','lime'][Math.floor(Math.random()*4)], text:'NUWAY LAB', textPos:['top','center','bottom'][Math.floor(Math.random()*3)]}); }

  // ---------- Init ----------
  (function init(){
    document.getElementById('year').textContent = new Date().getFullYear();
    renderProducts(); renderCart(); renderOrderSummary(); updateCartBadge(); newDesign();
  })();
  </script>
</body>
</html>
